#!/bin/sh
#
# Adam Tavares
# Feb 7, 2014
#
# Convert images into different formats
#
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
VERSION="ImageMagick-6.8.8-4"
INSTALL_LIB="$DIR/imagemagick"
IMAGE_MAGICK="$INSTALL_LIB/$VERSION"
OPEN_JPG_LIB="openjpeg-2.0.0"
JPG_LIB="jpeg-9"
JASPER="jasper-1.900.1"
JPG_GZ="jpegsrc.v9"
PNG_LIB="libpng-1.6.9"
TIFF_LIB="tiff-4.0.3"
exit_err() {
  [ $# -gt 0 ] && echo "fatal: $*" 1>&2
  exit 1
}
makeClean() {
	rm -rf $IMAGE_MAGICK
	rm -rf $INSTALL_LIB/$JPG_LIB
	rm -rf $INSTALL_LIB/$OPEN_JPG_LIB
	rm -rf $INSTALL_LIB/$PNG_LIB
	rm -rf $INSTALL_LIB/$TIFF_LIB
	rm -rf $INSTALL_LIB/$JASPER
}
formats() {
	convert -list configure | grep DELEGATES
}
install() {
	makeClean
	installDelegates
	installJasper
	installImagemagick
}
installDelegates() {
	installPngLib
	installTiffLib
	installJpgLib
}
installJasper() {
	cd $DIR/imagemagick
	unzip $JASPER.zip
	cd $JASPER
	./configure --prefix=/usr/local
	make check
	make
	make install
}
installImagemagick() {
	cd $DIR/imagemagick
	tar xvzf $VERSION.tar.gz
	cd $IMAGE_MAGICK
	./configure \
		LDFLAGS='-L/usr/local/lib' \
		CPPFLAGS='-I/usr/local/include' \
		--enable-delegate-build \
		--enable-shared \
		--disable-static \
		--disable-opencl \
		#--with-modules \
		--with-quantum-depth=16 \
		--with-gslib \
		--without-wmf \
		--disable-silent-rules \
		--disable-dependency-tracking \
		--with-perl=/usr/bin/perl \
		--with-png=yes \
		--with-jpeg=yes \
		--with-jp2=yes \
		--with-tiff=yes
	#make check
	make install
}
installPngLib() {
	# install png library
	cd $DIR/imagemagick
	tar xvzf $PNG_LIB.tar.gz
	cd $PNG_LIB
	./configure --prefix=/usr/local
	#make check
	make install
}
installTiffLib() {
	# install tiff library
	cd $DIR/imagemagick
	tar xvzf $TIFF_LIB.tar.gz
	cd $TIFF_LIB
	./configure --prefix=/usr/local
	#make check
	make install
}
installJpgLib() {
	cd $DIR/imagemagick
	tar xvzf $JPG_GZ.tar.gz
	cd  $JPG_LIB
	./configure --prefix=/usr/local
	make
	make test
	make install
}
installOpenJpegLib() {
	# install jpeg library
	cd $DIR/imagemagick
	tar xvzf $OPEN_JPG_LIB.tar.gz
	cd $OPEN_JPG_LIB
	cmake -DCMAKE_INSTALL_PREFIX=/usr/local .
	#make check
	make install
}
jpgToTiff() {
	SRC=$1
	OUT=$2
	pathCheck $2
	SRC_TYPE=$(fileType $1)
	if [ "$SRC_TYPE" != "JPEG" ]; then
		exit_err "Source file ${SRC} is not a jpeg."
	fi
	convert $SRC -compress jpeg -define tiff:tile-geometry=256x256 "ptif:${OUT}"
}
jp2ToJpeg() {
	SRC=$1
	OUT=$2
	pathCheck $2
	SRC_TYPE=$(fileType $1)
	if [ "$SRC_TYPE" != "JPEG" ]; then
		exit_err "Source file ${SRC} is not a jp2 file."
	fi
	jasper -f $SRC -F $OUT -T jpg
}
jp2ToTiff() {
	SRC=$1
	OUT=$2
	pathCheck $2
	SRC_TYPE=$(fileType $1)
	if [ "$SRC_TYPE" != "JPEG" ]; then
		exit_err "Source file ${SRC} is not a jp2 file."
	fi
	convert $SRC -compress jpeg -define tiff:tile-geometry=256x256 "ptif:${OUT}"
}
fileType() {
	TYPE=$(file $1 |tail -1|cut -d' ' -f2)
	echo $TYPE
}
config() {
	convert -list configure
}
# Check the output path and make intermediate directories
pathCheck() {
	OUT=$1
	OUTPATH=$( dirname $OUT )
	if [ ! -d "$OUTPATH" ]; then
		echo "Output directory not found.  New directory created at $OUTPATH"
		mkdir -p $OUTPATH
	fi
}

# What shall I do for you, sire?
CMD=$(echo "$1" | sed 's/\/$//'); shift

# Well I gotta do something!
if [ -z "$CMD" ]; then
	exit_err "No command was specified"
fi

# Okay let's get configured...
export MAGICK_HOME="$DIR/imagemagick/build"
export PATH="$MAGICK_HOME/bin:$PATH"
LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$MAGICK_HOME/lib"
export LD_LIBRARY_PATH
export DYLD_LIBRARY_PATH="$MAGICK_HOME/lib/"

if [ "$CMD" = "install" ]; then
	install
elif [ "$CMD" = "makeClean" ]; then
	makeClean
elif [ "$CMD" = "jpgToTiff" ]; then
	SRC=$(echo "$1" | sed 's/\/$//'); shift
	OUT=$(echo "$1" | sed 's/\/$//'); shift
	jpgToTiff $SRC $OUT
elif [ "$CMD" = "jp2ToJpeg" ]; then
	SRC=$(echo "$1" | sed 's/\/$//'); shift
	OUT=$(echo "$1" | sed 's/\/$//'); shift
	jp2ToJpeg $SRC $OUT
elif [ "$CMD" = "jp2ToTiff" ]; then
	SRC=$(echo "$1" | sed 's/\/$//'); shift
	OUT=$(echo "$1" | sed 's/\/$//'); shift
	jp2ToTiff $SRC $OUT
elif [ "$CMD" = "config" ]; then
	config
elif [ "$CMD" = "formats" ]; then
	formats
elif [ 1 -eq 1 ]; then
	exit_err "Command ${CMD} not found"
fi

